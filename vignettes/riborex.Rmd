---
title: "riborex Manual"
output: pdf_document
---

# Introduction

This is a manual to explain how the riborex is implemented based on current existing methods.  The requirement for input data format and parameters used in the implementation are specified in section `Data description`, and the implementation details are described in section `Implementations`. In this manual, we only show a dataset with two conditions, but the pipeline can also be used in data where there are multiple conditions involved.

Packed scripts that can be directly used are available on Github (`link`) for all the implementations mentioned here.


# Data description

Raw read counts from both Ribo-seq and RNA-seq are required as input. Here we will use a sample read count table for demonstration. We load the data from file `counts.RData` which is located in the same directory of this manual.

```{r}
load('counts.RData')
RNACntTable <- data$rna
RiboCntTable <- data$ribo
```

We can check the first five lines of the table:
```{r}
head(RNACntTable,5)
head(RiboCntTable,5)
```
Since there are only two conditions in the sample, we specify the numbers of samples for case and control in both Ribo-seq and RNA-seq data. Those numbers will be used for test design in the following section.

```{r}
numCaseRNASmps <- 2
numCtlRNASmps <- 2
numCaseRiboSmps <- 2
numCtlRiboSmps <- 2
```


# Implementations

Here we show how riborex is implemented based on edgeR, DESeq2 and voom, given the data and parameters we have in the previous seciton.

### Based on edgeR
To begin with, we load the library `edgeR` :
```{r message=FALSE}
library(edgeR)
```

Next, we prepare the factors:
```{r}
condition <- factor(c(rep(0, numCtlRNASmps), rep(1, numCaseRNASmps), 
                    rep(0, numCtlRiboSmps), rep(1, numCaseRiboSmps)))
dataType <- factor(c(rep(0, ncol(RNACntTable)), rep(1, ncol(RiboCntTable))))
TE <- factor(c(rep(0, ncol(RNACntTable) + numCtlRiboSmps), 
                  rep(1, numCaseRiboSmps))) # Indicator for differential TE
```
Combine Ribo-seq and RNA-seq read count tables and calculate the normalization factors:
```{r}
combCntTbl <- cbind(RNACntTable, RiboCntTable)
dge <- DGEList(counts = combCntTbl)
dge <- calcNormFactors(dge)
```
Then we specify the design matrix and estimate the dispersion for each gene:
```{r}
design <- model.matrix(~condition+dataType+TE)
dge <- estimateDisp(dge, design)
```
The read counts are then fit into GLM, and the likelihood ratio test is performed to detect genes with differential translation efficiency.
```{r}
fit <- glmFit(dge, design)
lrt <- glmLRT(fit)
Results <- topTags(lrt, n=Inf)
```
For example, the 20 most significant genes can be called in this way:
```{r}
topGenes <- Results@.Data[[1]]
head(topGenes,20)
```
The result can be exported:
```{r}
write.table(topGenes[rownames(RNACntTable),], "riborex_edgeR_result.txt", quote=FALSE)
```

### Based on DESeq2
First, we load the library `DESeq2`:
```{r message=FALSE}
library(DESeq2)
```
Next, we prepare the factors:
```{r}
condition <- factor(c(rep(0, numCtlRNASmps), rep(1, numCaseRNASmps), 
                    rep(0, numCtlRiboSmps), rep(1, numCaseRiboSmps)))
dataType <- factor(c(rep(0, ncol(RNACntTable)), rep(1, ncol(RiboCntTable))))
TE <- factor(c(rep(0, ncol(RNACntTable) + numCtlRiboSmps), 
                  rep(1, numCaseRiboSmps)))  # Indicator for differential TE
```
Combine Ribo-seq and RNA-seq read count tables and create design matrix:
```{r}
combCntTbl <- cbind(RNACntTable, RiboCntTable)
combColData <- data.frame(condition = condition)
combColData$dataType <- dataType
combColData$TE <- TE
rownames(combColData) <- colnames(combCntTbl)
dds <- DESeqDataSetFromMatrix(countData = combCntTbl,
                              colData = combColData,
                              design = ~condition + dataType + TE)
```
Finally, we estimate dispersions, fit the data into model.
```{r message=FALSE}
dds <- DESeq(dds)
res <- results(dds)
res
```
Please note that the rows all set to NAs are those where all counts equal to zero.


The result can be exported:
```{r}
write.table(res[rownames(RNACntTable),], "riborex_DESeq2_result.txt", quote=FALSE)
```


### Based on voom
First, we load the library `limma`:
```{r message=FALSE}
library(limma)
```
Next, we prepare the factors:
```{r}
condition <- factor(c(rep(0, numCtlRNASmps), rep(1, numCaseRNASmps), 
                    rep(0, numCtlRiboSmps), rep(1, numCaseRiboSmps)))
dataType <- factor(c(rep(0, ncol(RNACntTable)), rep(1, ncol(RiboCntTable))))
TE <- factor(c(rep(0, ncol(RNACntTable) + numCtlRiboSmps), 
                  rep(1, numCaseRiboSmps)))  # Indicator for differential TE
```
Combine Ribo-seq and RNA-seq read count tables and calculate the normalization factors:
```{r}
combCntTbl <- cbind(RNACntTable, RiboCntTable)
dge <- DGEList(counts = combCntTbl)
dge <- calcNormFactors(dge)
```
Then we specify the design matrix and apply the voom transformation:
```{r}
design <- model.matrix(~condition+dataType+TE)
v <- voom(dge, design, plot=FALSE)
```
The transformed data is fit into the model and result is obtained:
```{r}
fit <- lmFit(v, design)
fit <- eBayes(fit)
topGenes <- topTable(fit, coef=ncol(design), number=Inf)
```
For example, the 20 most significant genes can be called in this way:
```{r}
head(topGenes,20)
```
The result can be exported:
```{r}
write.table(topGenes[rownames(RNACntTable),], "riborex_voom_result.txt", quote=FALSE)
```





